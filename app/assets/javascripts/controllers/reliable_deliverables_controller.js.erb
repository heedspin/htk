function ReliableDeliverablesController() {
  HtkController.call(this, ReliableDeliverablesRouter.prototype.instance);
  this.query = new Object();
}

ReliableDeliverablesController.prototype = Object.create(HtkController.prototype);

ReliableDeliverablesController.prototype.setupEvents = function() {
  // User.prototype.all(null, {
  //   success : function(results) {
  //     var assigned = new Object();
  //     if (_this.deliverable) {
  //       _.each(_this.deliverable.responsible_users, function(du) { assigned[du.user_id] = true; });           
  //     }
  //     var options = $(HandlebarsTemplates['users/options']({assigned: assigned,  users: results.users}));
  //     var select = edit_form.find("select[name=assigned_users]");
  //     select.empty().append(options);
  //     select.multiselect({
  //       selectedText: selectedText,
  //       noneSelectedText: noneSelectedText
  //     });//.multiselectfilter();
  //   }
  // });

}

ReliableDeliverablesController.prototype.loadController = function() {
  this.container = $("#rdbls");
  this.container.empty().append($(HandlebarsTemplates['reliable_deliverables/index']()));
  this.filterForm = this.container.find("form");
  this.query['type'] = <%= DeliverableTypeConfig.standard.id %>;
  this.query['responsible'] = true;
  this.query['user_id'] = this.getCurrentUser().id;
  var _this = this;
  var joiner = new HtkJoiner();
  User.prototype.all(null, {
    success : function(results) {
      var options = HandlebarsTemplates['users/single_select']({selected_user: _this.query.user_id, users: results.users});
      _this.filterForm.find("select[name=assigned-user]").empty().append($(options));
    },
    joiner : joiner
  });
  DeliverableType.prototype.all(null, {
    success : function(results) {
      var options = HandlebarsTemplates["deliverable_types/single_select"]({selected: _this.query.type, deliverable_types: results.deliverable_types});
      _this.filterForm.find("select[name=deliverable-type]").empty().append($(options));
    },
    joiner : joiner
  })
  joiner.join(function() { _this.getDeliverables(); });
}

ReliableDeliverablesController.prototype.getDeliverables = function() {
  var _this = this;
  Deliverable.prototype.all(this.query, {
    success : function(results) {
      var deliverables = results.deliverables
      htkLog("Loaded " + deliverables.length + " deliverables");
      var table = $(HandlebarsTemplates['reliable_deliverables/table']());
      _this.container.find(".deliverables-list").append(table);
      _.each(deliverables, function(d) {
        var row = $(HandlebarsTemplates['reliable_deliverables/row']({ 
          deliverable: d, 
          project: d.getProject(), 
          company: d.getCompany()
        }));
        table.append(row);
      });
    }
  });  
}
